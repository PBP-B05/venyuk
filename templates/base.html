{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    {% block meta %}{% endblock meta %}
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
  </head>
  <body>
    {% include 'navbar.html' %}

    <main class="pt-24">
      {% block content %}{% endblock content %}
    </main>
  </body>

  <!-- Toast -->
  <div id="toast" class="fixed top-5 right-5 hidden z-[9999]">
    <div id="toastContent" class="bg-gray-800 text-white px-5 py-3 rounded-lg shadow-lg"></div>
  </div>

  <script>
    function showToast(message, success=true) {
      const toast = document.getElementById('toast');
      const toastContent = document.getElementById('toastContent');
      toastContent.textContent = message;
      toastContent.className = success 
        ? "bg-green-600 text-white px-5 py-3 rounded-lg shadow-lg"
        : "bg-red-600 text-white px-5 py-3 rounded-lg shadow-lg";

      toast.classList.remove('hidden');
      setTimeout(() => { toast.classList.add('hidden'); }, 3000);
    }

    // Modal control
    document.getElementById("closeLoginModal")?.addEventListener("click", () => {
      document.getElementById("loginModal")?.classList.add("hidden");
    });
    document.getElementById("openLoginModal")?.addEventListener("click", () => {
      document.getElementById("loginModal")?.classList.remove("hidden");
    });

    // AJAX login
    document.getElementById("loginForm")?.addEventListener("submit", async function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      const response = await fetch("{% url 'authenticate:login' %}", {
        method: "POST",
        headers: { "X-CSRFToken": csrfToken, "X-Requested-With": "XMLHttpRequest" },
        body: formData
      });

      const data = await response.json();
      if (response.ok && data.status) {
        showToast("Login berhasil! Selamat datang, " + data.username);
        document.getElementById("loginModal")?.classList.add("hidden");
        setTimeout(() => location.reload(), 1500);
      } else {
        showToast(data.message || "Login gagal!", false);
      }
    });
  </script>
</html>
